import{_ as e,c as s,o as n,a}from"./app.aa76e8ed.js";const u=JSON.parse('{"title":"Chapter 13 Comments Should Describe Things that Aren\u2019t Obvious from the Code","description":"","frontmatter":{},"headers":[{"level":2,"title":"13.1 Pick conventions","slug":"_13-1-pick-conventions"},{"level":2,"title":"13.2 Don\u2019t repeat the code","slug":"_13-2-don\u2019t-repeat-the-code"},{"level":2,"title":"13.3 Lower-level comments add precision","slug":"_13-3-lower-level-comments-add-precision"},{"level":2,"title":"13.4 Higher-level comments enhance intuition","slug":"_13-4-higher-level-comments-enhance-intuition"},{"level":2,"title":"13.5 Interface documentation","slug":"_13-5-interface-documentation"},{"level":2,"title":"13.6 Implementation comments: what and why, not how","slug":"_13-6-implementation-comments-what-and-why-not-how"},{"level":2,"title":"13.7 Cross-module design decisions","slug":"_13-7-cross-module-design-decisions"},{"level":2,"title":"13.8 Conclusion","slug":"_13-8-conclusion"},{"level":2,"title":"13.9 Answers to questions from Section 13.5","slug":"_13-9-answers-to-questions-from-section-13-5"}],"relativePath":"comments-should-describe-things-that-are-not-obvious-from-the-code.md","lastUpdated":1661434746000}'),t={name:"comments-should-describe-things-that-are-not-obvious-from-the-code.md"},o=a(`<h1 id="chapter-13-comments-should-describe-things-that-aren\u2019t-obvious-from-the-code" tabindex="-1">Chapter 13 Comments Should Describe Things that Aren\u2019t Obvious from the Code <a class="header-anchor" href="#chapter-13-comments-should-describe-things-that-aren\u2019t-obvious-from-the-code" aria-hidden="true">#</a></h1><p>The reason for writing comments is that statements in a programming language can\u2019t capture all of the important information that was in the mind of the developer when the code was written. Comments record this information so that developers who come along later can easily understand and modify the code. The guiding principle for comments is that comments should describe things that aren\u2019t obvious from the code.</p><p>There are many things that aren\u2019t obvious from the code. Sometimes it\u2019s low-level details that aren\u2019t obvious. For example, when a pair of indices describe a range, it isn\u2019t obvious whether the elements given by the indices are inside the range or out. Sometimes it\u2019s not clear why code is needed, or why it was implemented in a particular way. Sometimes there are rules the developer followed, such as \u201Calways invoke a before b.\u201D You might be able to guess at a rule by looking at all of the code, but this is painful and error-prone; a comment can make the rule explicit and clear.</p><p>One of the most important reasons for comments is abstractions, which include a lot of information that isn\u2019t obvious from the code. The idea of an abstraction is to provide a simple way of thinking about something, but code is so detailed that it can be hard to see the abstraction just from reading the code. Comments can provide a simpler, higher-level view (\u201Cafter this method is invoked, network traffic will be limited to maxBandwidth bytes per second\u201D). Even if this information can be deduced by reading the code, we don\u2019t want to force users of a module to do that: reading the code is time-consuming and forces them to consider a lot of information that isn\u2019t needed to use the module. Developers should be able to understand the abstraction provided by a module without reading any code other than its externally visible declarations. The only way to do this is by supplementing the declarations with comments.</p><p>This chapter discusses what information needs to be described in comments and how to write good comments. As you will see, good comments typically explain things at a different level of detail than the code, which is more detailed in some situations and less detailed (more abstract) in others.</p><h2 id="_13-1-pick-conventions" tabindex="-1">13.1 Pick conventions <a class="header-anchor" href="#_13-1-pick-conventions" aria-hidden="true">#</a></h2><p>The first step in writing comments is to decide on conventions for commenting, such as what you will comment and the format you will use for comments. If you are programming in a language for which there exists a document compilation tool, such as Javadoc for Java, Doxygen for C++, or godoc for Go!, follow the conventions of the tools. None of these conventions is perfect, but the tools provide enough benefits to make up for that. If you are programming in an environment where there are no existing conventions to follow, try to adopt the conventions from some other language or project that is similar; this will make it easier for other developers to understand and adhere to your conventions.</p><p>Conventions serve two purposes. First, they ensure consistency, which makes comments easier to read and understand. Second, they help to ensure that you actually write comments. If you don\u2019t have a clear idea what you are going to comment and how, it\u2019s easy to end up writing no comments at all.</p><p>Most comments fall into one of the following categories:</p><p>Interface: a comment block that immediately precedes the declaration of a module such as a class, data structure, function, or method. The comment describe\u2019s the module\u2019s interface. For a class, the comment describes the overall abstraction provided by the class. For a method or function, the comment describes its overall behavior, its arguments and return value, if any, any side effects or exceptions that it generates, and any other requirements the caller must satisfy before invoking the method.</p><p>Data structure member: a comment next to the declaration of a field in a data structure, such as an instance variable or static variable for a class.</p><p>Implementation comment: a comment inside the code of a method or function, which describes how the code works internally.</p><p>Cross-module comment: a comment describing dependencies that cross module boundaries.</p><p>The most important comments are those in the first two categories. Every class should have an interface comment, every class variable should have a comment, and every method should have an interface comment. Occasionally, the declaration for a variable or method is so obvious that there is nothing useful to add in a comment (getters and setters sometimes fall in this category), but this is rare; it is easier to comment everything rather than spend energy worrying about whether a comment is needed. Implementation comments are often unnecessary (see Section 13.6 below). Cross-module comments are the most rare of all and they are problematic to write, but when they are needed they are quite important; Section 13.7 discusses them in more detail.</p><h2 id="_13-2-don\u2019t-repeat-the-code" tabindex="-1">13.2 Don\u2019t repeat the code <a class="header-anchor" href="#_13-2-don\u2019t-repeat-the-code" aria-hidden="true">#</a></h2><p>Unfortunately, many comments are not particularly helpful. The most common reason is that the comments repeat the code: all of the information in the comment can easily be deduced from the code next to the comment. Here is a code sample that appeared in a recent research paper:</p><div class="language-sh"><button class="copy"></button><span class="lang">sh</span><pre><code><span class="line"><span style="color:#A6ACCD;">ptr_copy = get_copy</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">obj</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">            </span><span style="color:#676E95;"># Get pointer copy</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> is_unlocked</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ptr_copy</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">:           </span><span style="color:#676E95;"># Is obj free?</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> obj                      </span><span style="color:#676E95;"># return current obj</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> is_copy</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ptr_copy</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">:               </span><span style="color:#676E95;"># Already a copy?</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> obj                      </span><span style="color:#676E95;"># return obj</span></span>
<span class="line"><span style="color:#A6ACCD;">thread_id = get_thread_id</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ptr_copy</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> thread_id == ctx.thread_id:      </span><span style="color:#676E95;"># Locked by current ctx</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> ptr_copy                 </span><span style="color:#676E95;"># Return copy</span></span>
<span class="line"></span></code></pre></div><p>There is no useful information in any of these comments except for the \u201CLocked by\u201D comment, which suggests something about the thread that might not be obvious from the code. Notice that these comments are at roughly the same level of detail as the code: there is one comment per line of code, which describes that line. Comments like this are rarely useful.</p><p>Here are more examples of comments that repeat the code:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">// Add a horizontal scroll bar</span></span>
<span class="line"><span style="color:#A6ACCD;">hScrollBar </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">JScrollBar</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">JScrollBar</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">HORIZONTAL</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">hScrollBar</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> BorderLayout</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">SOUTH</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// Add a vertical scroll bar</span></span>
<span class="line"><span style="color:#A6ACCD;">vScrollBar </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">JScrollBar</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">JScrollBar</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">VERTICAL</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">vScrollBar</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> BorderLayout</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">EAST</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// Initialize the caret-position related values</span></span>
<span class="line"><span style="color:#A6ACCD;">caretX     </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">caretY     </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">caretMemX  </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null;</span></span>
<span class="line"></span></code></pre></div><p>None of these comments provide any value. For the first two comments, the code is already clear enough that it doesn\u2019t really need comments; in the third case, a comment might be useful, but the current comment doesn\u2019t provide enough detail to be helpful.</p><p>After you have written a comment, ask yourself the following question: could someone who has never seen the code write the comment just by looking at the code next to the comment? If the answer is yes, as in the examples above, then the comment doesn\u2019t make the code any easier to understand. Comments like these are why some people think that comments are worthless.</p><p>Another common mistake is to use the same words in the comment that appear in the name of the entity being documented:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/*</span></span>
<span class="line"><span style="color:#676E95;"> * Obtain a normalized resource name from REQ.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getNormalizedResourceNames</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">HTTPRequest</span><span style="color:#A6ACCD;"> req</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#676E95;">/*</span></span>
<span class="line"><span style="color:#676E95;"> * Downcast PARAMETER to TYPE.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Object</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">downCastParameter</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> parameter</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> type</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#676E95;">/*</span></span>
<span class="line"><span style="color:#676E95;"> * The horizontal padding of each line in the text.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> textHorizontalPadding </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>These comments just take the words from the method or variable name, perhaps add a few words from argument names and types, and form them into a sentence. For example, the only thing in the second comment that isn\u2019t in the code is the word \u201Cto\u201D! Once again, these comments could be written just by looking at the declarations, without any understanding the methods of variables; as a result, they have no value.</p><p>img Red Flag: Comment Repeats Code img</p><p>If the information in a comment is already obvious from the code next to the comment, then the comment isn\u2019t helpful. One example of this is when the comment uses the same words that make up the name of the thing it is describing.</p><p>At the same time, there is important information that is missing from the comments: for example, what is a \u201Cnormalized resource name\u201D, and what are the elements of the array returned by getNormalizedResourceNames? What does \u201Cdowncast\u201D mean? What are the units of padding, and is the padding on one side of each line or both? Describing these things in comments would be helpful.</p><p>A first step towards writing good comments is to use different words in the comment from those in the name of the entity being described. Pick words for the comment that provide additional information about the meaning of the entity, rather than just repeating its name. For example, here is a better comment for textHorizontalPadding:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/*</span></span>
<span class="line"><span style="color:#676E95;"> * The amount of blank space to leave on the left and</span></span>
<span class="line"><span style="color:#676E95;"> * right sides of each line of text, in pixels.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">final</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> textHorizontalPadding </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>This comment provides additional information that is not obvious from the declaration itself, such as the units (pixels) and the fact that padding applies to both sides of each line. Instead of using the term \u201Cpadding\u201D, the comment explains what padding is, in case the reader isn\u2019t already familiar with the term.</p><h2 id="_13-3-lower-level-comments-add-precision" tabindex="-1">13.3 Lower-level comments add precision <a class="header-anchor" href="#_13-3-lower-level-comments-add-precision" aria-hidden="true">#</a></h2><p>Now that you know what not to do, let\u2019s discuss what information you should put in comments. Comments augment the code by providing information at a different level of detail. Some comments provide information at a lower, more detailed, level than the code; these comments add precision by clarifying the exact meaning of the code. Other comments provide information at a higher, more abstract, level than the code; these comments offer intuition, such as the reasoning behind the code, or a simpler and more abstract way of thinking about the code. Comments at the same level as the code are likely to repeat the code. This section discusses the lower-level approach in more detail, and the next section discusses the higher-level approach.</p><p>Precision is most useful when commenting variable declarations such as class instance variables, method arguments, and return values. The name and type in a variable declaration are typically not very precise. Comments can fill in missing details such as:</p><ul><li>What are the units for this variable?</li><li>Are the boundary conditions inclusive or exclusive?</li><li>If a null value is permitted, what does it imply?</li><li>If a variable refers to a resource that must eventually be freed or closed, who is responsible for freeing or closing it?</li><li>Are there certain properties that are always true for the variable (invariants), such as \u201Cthis list always contains at least one entry\u201D?</li></ul><hr><p>Some of this information could potentially be figured out by examining all of the code where the variable is used. However, this is time-consuming and error-prone; the declaration\u2019s comment should be clear and complete enough to make this unnecessary. When I say that the comment for a declaration should describe things that aren\u2019t obvious from the code, \u201Cthe code\u201D refers to the code next to the comment (the declaration), not \u201Call of the code in the application.\u201D</p><p>The most common problem with comments for variables is that the comments are too vague. Here are two examples of comments that aren\u2019t precise enough:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">// Current offset in resp Buffer</span></span>
<span class="line"><span style="color:#A6ACCD;">uint32_t offset</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">// Contains all line-widths inside the document and</span></span>
<span class="line"><span style="color:#676E95;">// number of appearances.</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TreeMap</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> lineWidths</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>In the first example, it\u2019s not clear what \u201Ccurrent\u201D means. In the second example, it\u2019s not clear that the keys in the TreeMap are line widths and values are occurrence counts. Also, are widths measured in pixels or characters? The revised comments below provide additional details:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">//  Position in this buffer of the first object that hasn&#39;t</span></span>
<span class="line"><span style="color:#676E95;">//  been returned to the client.</span></span>
<span class="line"><span style="color:#A6ACCD;">uint32_t offset</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">//  Holds statistics about line lengths of the form &lt;length, count&gt;</span></span>
<span class="line"><span style="color:#676E95;">//  where length is the number of characters in a line (including</span></span>
<span class="line"><span style="color:#676E95;">//  the newline), and count is the number of lines with</span></span>
<span class="line"><span style="color:#676E95;">//  exactly that many characters. If there are no lines with</span></span>
<span class="line"><span style="color:#676E95;">//  a particular length, then there is no entry for that length.</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TreeMap</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> numLinesWithLength</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>The second declaration uses a longer name that conveys more information. It also changes \u201Cwidth\u201D to \u201Clength\u201D, because this term is more likely to make people think that the units are characters rather than pixels. Notice that the second comment documents not only the details of each entry, but also what it means if an entry is missing.</p><p>When documenting a variable, think nouns, not verbs. In other words, focus on what the variable represents, not how it is manipulated. Consider the following comment:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/* FOLLOWER VARIABLE: indicator variable that allows the Receiver and the</span></span>
<span class="line"><span style="color:#676E95;"> * PeriodicTasks thread to communicate about whether a heartbeat has been</span></span>
<span class="line"><span style="color:#676E95;"> * received within the follower&#39;s election timeout window.</span></span>
<span class="line"><span style="color:#676E95;"> * Toggled to TRUE when a valid heartbeat is received.</span></span>
<span class="line"><span style="color:#676E95;"> * Toggled to FALSE when the election timeout window is reset.  */</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> receivedValidHeartbeat</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>This documentation describes how the variable is modified by several pieces of code in the class. The comment will be both shorter and more useful if it describes what the variable represents rather than mirroring the code structure:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/* True means that a heartbeat has been received since the last time</span></span>
<span class="line"><span style="color:#676E95;"> * the election timer was reset. Used for communication between the</span></span>
<span class="line"><span style="color:#676E95;"> * Receiver and PeriodicTasks threads.  */</span></span>
<span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> receivedValidHeartbeat</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>Given this documentation, it\u2019s easy to infer that the variable must be set to true when a heartbeat is received and false when the election timer is reset.</p><h2 id="_13-4-higher-level-comments-enhance-intuition" tabindex="-1">13.4 Higher-level comments enhance intuition <a class="header-anchor" href="#_13-4-higher-level-comments-enhance-intuition" aria-hidden="true">#</a></h2><p>The second way in which comments can augment code is by providing intuition. These comments are written at a higher level than the code. They omit details and help the reader to understand the overall intent and structure of the code. This approach is commonly used for comments inside methods, and for interface comments. For example, consider the following code:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">// If there is a LOADING readRpc using the same session</span></span>
<span class="line"><span style="color:#676E95;">// as PKHash pointed to by assignPos, and the last PKHash</span></span>
<span class="line"><span style="color:#676E95;">// in that readRPC is smaller than current assigning</span></span>
<span class="line"><span style="color:#676E95;">// PKHash, then we put assigning PKHash into that readRPC.</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> readActiveRpcId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> RPC_ID_NOT_ASSIGNED</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> NUM_READ_RPC</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">session </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> readRpc</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">session</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> readRpc</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">status </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">LOADING</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> readRpc</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">maxPos </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> assignPos</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> readRpc</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">numHashes </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> MAX_PKHASHES_PERRPC</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        readActiveRpcId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>The comment is too low-level and detailed. On the one hand, it partially repeats the code: \u201Cif there is a LOADING readRPC\u201D just duplicates the test <code>readRpc[i].status == LOADING</code>. On the other hand, the comment doesn\u2019t explain the overall purpose of this code, or how it fits into the method that contains it. As a result, the comment doesn\u2019t help the reader to understand the code.</p><p>Here is a better comment:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">// Try to append the current key hash onto an existing</span></span>
<span class="line"><span style="color:#676E95;">// RPC to the desired server that hasn&#39;t been sent yet.</span></span>
<span class="line"></span></code></pre></div><p>This comment doesn\u2019t contain any details; instead, it describes the code\u2019s overall function at a higher level. With this high-level information, a reader can explain almost everything that happens in the code: the loop must be iterating over all the existing remote procedure calls (RPCs); the session test is probably used to see if a particular RPC is destined for the right server; the LOADING test suggests that RPCs can have multiple states, and in some states it isn\u2019t safe to add more hashes; the MAX - PKHASHES_PERRPC test suggests that there is a limit to how many hashes can be sent in a single RPC. The only thing not explained by the comment is the maxPos test. Furthermore, the new comment provides a basis for readers to judge the code: does it do everything that is needed to add the key hash to an existing RPC? The original comment didn\u2019t describe the overall intent of the code, so it\u2019s hard for a reader to decide whether the code is behaving correctly.</p><p>Higher-level comments are more difficult to write than lower-level comments because you must think about the code in a different way. Ask yourself: What is this code trying to do? What is the simplest thing you can say that explains everything in the code? What is the most important thing about this code?</p><p>Engineers tend to be very detail-oriented. We love details and are good at managing lots of them; this is essential for being a good engineer. But, great software designers can also step back from the details and think about a system at a higher level. This means deciding which aspects of the system are most important, and being able to ignore the low-level details and think about the system only in terms of its most fundamental characteristics. This is the essence of abstraction (finding a simple way to think about a complex entity), and it\u2019s also what you must do when writing higher-level comments. A good higher-level comment expresses one or a few simple ideas that provide a conceptual framework, such as \u201Cappend to an existing RPC.\u201D Given the framework, it becomes easy to see how specific code statements relate to the overall goal.</p><p>Here is another code sample, which has a good higher-level comment:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">numProcessedPKHashes </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> readRpc</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">i</span><span style="color:#89DDFF;">].</span><span style="color:#A6ACCD;">numHashes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// Some of the key hashes couldn&#39;t be looked up in</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// this request (either because they aren&#39;t stored</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// on the server, the server crashed, or there</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// wasn&#39;t enough space in the response message).</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// Mark the unprocessed hashes so they will get</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;">// reassigned to new RPCs.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">size_t p </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> removePos</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> p </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> insertPos</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">++)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">activeRpcId</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> i</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">numProcessedPKHashes </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                numProcessedPKHashes</span><span style="color:#89DDFF;">--;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">else</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">p </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> assignPos</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                    assignPos </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> p</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                activeRpcId</span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">p</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> RPC_ID_NOT_ASSIGNED</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>This comment does two things. The second sentence provides an abstract description of what the code does. The first sentence is different: it explains (in high level terms) why the code is executed. Comments of the form \u201Chow we get here\u201D are very useful for helping people to understand code. For example, when documenting a method, it can be very helpful to describe the conditions under which the method is most likely to be invoked (especially if the method is only invoked in unusual situations).</p><h2 id="_13-5-interface-documentation" tabindex="-1">13.5 Interface documentation <a class="header-anchor" href="#_13-5-interface-documentation" aria-hidden="true">#</a></h2><p>One of the most important roles for comments is to define abstractions. Recall from Chapter 4 that an abstraction is a simplified view of an entity, which preserves essential information but omits details that can safely be ignored. Code isn\u2019t suitable for describing abstractions; it\u2019s too low level and it includes implementation details that shouldn\u2019t be visible in the abstraction. The only way to describe an abstraction is with comments. If you want code that presents good abstractions, you must document those abstractions with comments.</p><p>The first step in documenting abstractions is to separate interface comments from implementation comments. Interface comments provide information that someone needs to know in order to use a class or method; they define the abstraction. Implementation comments describe how a class or method works internally in order to implement the abstraction. It\u2019s important to separate these two kinds of comments, so that users of an interface are not exposed to implementation details. Furthermore, these two forms had better be different. If interface comments must also describe the implementation, then the class or method is shallow. This means that the act of writing comments can provide clues about the quality of a design; Chapter 15 will return to this idea.</p><p>The interface comment for a class provides a high-level description of the abstraction provided by the class, such as the following:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;"> * This class implements a simple server-side interface to the HTTP</span></span>
<span class="line"><span style="color:#676E95;"> * protocol: by using this class, an application can receive HTTP</span></span>
<span class="line"><span style="color:#676E95;"> * requests, process them, and return responses. Each instance of</span></span>
<span class="line"><span style="color:#676E95;"> * this class corresponds to a particular socket used to receive</span></span>
<span class="line"><span style="color:#676E95;"> * requests. The current implementation is single-threaded and</span></span>
<span class="line"><span style="color:#676E95;"> * processes one request at a time.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Http</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{...}</span></span>
<span class="line"></span></code></pre></div><p>This comment describes the overall capabilities of the class, without any implementation details or even the specifics of particular methods. It also describes what each instance of the class represents. Finally, the comments describe the limitations of the class (it does not support concurrent access from multiple threads), which may be important to developers contemplating whether to use it.</p><p>The interface comment for a method includes both higher-level information for abstraction and lower-level details for precision:</p><ul><li>The comment usually starts with a sentence or two describing the behavior of the method as perceived by callers; this is the higher-level abstraction.</li><li>The comment must describe each argument and the return value (if any). These comments must be very precise, and must describe any constraints on argument values as well as dependencies between arguments.</li><li>If the method has any side effects, these must be documented in the interface comment. A side effect is any consequence of the method that affects the future behavior of the system but is not part of the result. For example, if the method adds a value to an internal data structure, which can be retrieved by future method calls, this is a side effect; writing to the file system is also a side effect.</li><li>A method\u2019s interface comment must describe any exceptions that can emanate from the method.</li><li>If there are any preconditions that must be satisfied before a method is invoked, these must be described (perhaps some other method must be invoked first; for a binary search method, the list being searched must be sorted). It is a good idea to minimize preconditions, but any that remain must be documented.</li></ul><hr><p>Here is the interface comment for a method that copies data out of a Buffer object:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;"> * Copy a range of bytes from a buffer to an external location.</span></span>
<span class="line"><span style="color:#676E95;"> *</span></span>
<span class="line"><span style="color:#676E95;"> * \\param offset</span></span>
<span class="line"><span style="color:#676E95;"> *        Index within the buffer of the first byte to copy.</span></span>
<span class="line"><span style="color:#676E95;"> * \\param length</span></span>
<span class="line"><span style="color:#676E95;"> *        Number of bytes to copy.</span></span>
<span class="line"><span style="color:#676E95;"> * \\param dest</span></span>
<span class="line"><span style="color:#676E95;"> *        Where to copy the bytes: must have room for at least</span></span>
<span class="line"><span style="color:#676E95;"> *        length bytes.</span></span>
<span class="line"><span style="color:#676E95;"> *</span></span>
<span class="line"><span style="color:#676E95;"> * \\return</span></span>
<span class="line"><span style="color:#676E95;"> *        The return value is the actual number of bytes copied,</span></span>
<span class="line"><span style="color:#676E95;"> *        which may be less than length if the requested range of</span></span>
<span class="line"><span style="color:#676E95;"> *        bytes extends past the end of the buffer. 0 is returned</span></span>
<span class="line"><span style="color:#676E95;"> *        if there is no overlap between the requested range and</span></span>
<span class="line"><span style="color:#676E95;"> *        the actual buffer.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">uint32_t</span></span>
<span class="line"><span style="color:#A6ACCD;">Buffer</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">copy</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">uint32_t offset</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> uint32_t length</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> dest</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">...</span></span>
<span class="line"></span></code></pre></div><p>The syntax of this comment (e.g., \\return) follows the conventions of Doxygen, a program that extracts comments from C/C++ code and compiles them into Web pages. The goal of the comment is to provide all the information a developer needs in order to invoke the method, including how special cases are handled (note how this method follows the advice of Chapter 10 and defines out of existence any errors associated with the range specification). The developer should not need to read the body of the method in order to invoke it, and the interface comment provides no information about how the method is implemented, such as how it scans its internal data structures to find the desired data.</p><p>For a more extended example, let\u2019s consider a class called IndexLookup, which is part of a distributed storage system. The storage system holds a collection of tables, each of which contains many objects. In addition, each table can have one or more indexes; each index provides efficient access to objects in the table based on a particular field of the object. For example, one index might be used to look up objects based on their name field, and another index might be used to look up objects based on their age field. With these indexes, applications can quickly extract all of the objects with a particular name, or all of those with an age in a given range.</p><p>The IndexLookup class provides a convenient interface for performing indexed lookups. Here is an example of how it might be used in an application:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#A6ACCD;">query </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">IndexLookup</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">table</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> index</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> key1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> key2</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">while</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">(true)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    object </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> query</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getNext</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">object </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> NULL</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">break</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">...</span><span style="color:#A6ACCD;"> process object </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>The application first constructs an object of type IndexLookup, providing arguments that select a table, an index, and a range within the index (for example, if the index is based on an age field, key1 and key2 might be specified as 21 and 65 to select all objects with ages between those values). Then the application calls the getNext method repeatedly. Each invocation returns one object that falls within the desired range; once all of the matching objects have been returned, getNext returns NULL. Because the storage system is distributed, the implementation of this class is somewhat complex. The objects in a table may be spread across multiple servers, and each index may also be distributed across a different set of servers; the code in the IndexLookup class must first communicate with all of the relevant index servers to collect information about the objects in the range, then it must communicate with the servers that actually store the objects in order to retrieve their values.</p><p>Now let\u2019s consider what information needs to be included in the interface comment for this class. For each piece of information given below, ask yourself whether a developer needs to know that information in order to use the class (my answers to the questions are at the end of the chapter):</p><ol><li>The format of messages that the IndexLookup class sends to the servers holding indexes and objects.</li><li>The comparison function used to determine whether a particular object falls in the desired range (is comparison done using integers, floating-point numbers, or strings?).</li><li>The data structure used to store indexes on servers.</li><li>Whether or not IndexLookup issues multiple requests to different servers concurrently.</li><li>The mechanism for handling server crashes.</li></ol><hr><p>Here is the original version of the interface comment for the IndexLookup class; the excerpt also includes a few lines from the class\u2019s definition, which are referred to in the comment:</p><div class="language-cpp"><button class="copy"></button><span class="lang">cpp</span><pre><code><span class="line"><span style="color:#676E95;">/*</span></span>
<span class="line"><span style="color:#676E95;"> * This class implements the client side framework for index range</span></span>
<span class="line"><span style="color:#676E95;"> * lookups. It manages a single LookupIndexKeys RPC and multiple</span></span>
<span class="line"><span style="color:#676E95;"> * IndexedRead RPCs. Client side just includes &quot;IndexLookup.h&quot; in</span></span>
<span class="line"><span style="color:#676E95;"> * its header to use IndexLookup class. Several parameters can be set</span></span>
<span class="line"><span style="color:#676E95;"> * in the config below:</span></span>
<span class="line"><span style="color:#676E95;"> * - The number of concurrent indexedRead RPCs</span></span>
<span class="line"><span style="color:#676E95;"> * - The max number of PKHashes a indexedRead RPC can hold at a time</span></span>
<span class="line"><span style="color:#676E95;"> * - The size of the active PKHashes</span></span>
<span class="line"><span style="color:#676E95;"> *</span></span>
<span class="line"><span style="color:#676E95;"> * To use IndexLookup, the client creates an object of this class by</span></span>
<span class="line"><span style="color:#676E95;"> * providing all necessary information. After construction of</span></span>
<span class="line"><span style="color:#676E95;"> * IndexLookup, client can call getNext() function to move to next</span></span>
<span class="line"><span style="color:#676E95;"> * available object. If getNext() returns NULL, it means we reached</span></span>
<span class="line"><span style="color:#676E95;"> * the last object. Client can use getKey, getKeyLength, getValue,</span></span>
<span class="line"><span style="color:#676E95;"> * and getValueLength to get object data of current object.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">class</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">IndexLookup</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">       ...</span></span>
<span class="line"><span style="color:#F07178;">   </span><span style="color:#C792EA;">private</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#676E95;">       /// Max number of concurrent indexedRead RPCs</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">static</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint8_t</span><span style="color:#F07178;"> NUM_READ_RPC </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;">       /// Max number of PKHashes that can be sent in one</span></span>
<span class="line"><span style="color:#676E95;">       /// indexedRead RPC</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">static</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">uint32_t</span><span style="color:#F07178;"> MAX_PKHASHES_PERRPC </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">256</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;">       /// Max number of PKHashes that activeHashes can</span></span>
<span class="line"><span style="color:#676E95;">       /// hold at once.</span></span>
<span class="line"><span style="color:#F07178;">       </span><span style="color:#C792EA;">static</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">size_t</span><span style="color:#F07178;"> MAX_NUM_PK </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#F07178;"> LG_BUFFER_SIZE</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>Before reading further, see if you can identify the problems with this comment. Here are the problems that I found:</p><ul><li>Most of the first paragraph concerns the implementation, not the interface. As one example, users don\u2019t need to know the names of the particular remote procedure calls used to communicate with the servers. The configuration parameters referred to in the second half of the first paragraph are all private variables that are relevant only to the maintainer of the class, not to its users. All of this implementation information should be omitted from the comment.</li><li>The comment also includes several things that are obvious. For example, there\u2019s no need to tell users to include IndexLookup.h: anyone who writes C++ code will be able to guess that this is necessary. In addition, the text \u201Cby providing all necessary information\u201D says nothing, so it can be omitted.</li></ul><hr><p>A shorter comment for this class is sufficient (and preferable):</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/*</span></span>
<span class="line"><span style="color:#676E95;"> * This class is used by client applications to make range queries</span></span>
<span class="line"><span style="color:#676E95;"> * using indexes. Each instance represents a single range query.</span></span>
<span class="line"><span style="color:#676E95;"> *</span></span>
<span class="line"><span style="color:#676E95;"> * To start a range query, a client creates an instance of this</span></span>
<span class="line"><span style="color:#676E95;"> * class. The client can then call getNext() to retrieve the objects</span></span>
<span class="line"><span style="color:#676E95;"> * in the desired range. For each object returned by getNext(), the</span></span>
<span class="line"><span style="color:#676E95;"> * caller can invoke getKey(), getKeyLength(), getValue(), and</span></span>
<span class="line"><span style="color:#676E95;"> * getValueLength() to get information about that object.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"></span></code></pre></div><p>The last paragraph of this comment is not strictly necessary, since it mostly duplicates information in the comments for individual methods. However, it can be helpful to have examples in the class documentation that illustrate how its methods work together, particularly for deep classes with usage patterns that are nonobvious. Note that the new comment does not mention NULL return values from getNext. This comment is not intended to document every detail of each method; it just provides high level information to help readers understand how the methods work together and when each method might be invoked. For details, readers can refer to the interface comments for individual methods. This comment also does not mention server crashes; that is because server crashes are invisible to users of this class (the system automatically recovers from them).</p><p>img Red Flag: Implementation Documentation Contaminates Interface img</p><p>This red flag occurs when interface documentation, such as that for a method, describes implementation details that aren\u2019t needed in order to use the thing being documented.</p><p>Now consider the following code, which shows the first version of the documentation for the isReady method in IndexLookup:</p><div class="language-cpp"><button class="copy"></button><span class="lang">cpp</span><pre><code><span class="line"><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;"> * Check if the next object is RESULT_READY. This function is</span></span>
<span class="line"><span style="color:#676E95;"> * implemented in a DCFT module, each execution of isReady() tries</span></span>
<span class="line"><span style="color:#676E95;"> * to make small progress, and getNext() invokes isReady() in a</span></span>
<span class="line"><span style="color:#676E95;"> * while loop, until isReady() returns true.</span></span>
<span class="line"><span style="color:#676E95;"> *</span></span>
<span class="line"><span style="color:#676E95;"> * isReady() is implemented in a rule-based approach. We check</span></span>
<span class="line"><span style="color:#676E95;"> * different rules by following a particular order, and perform</span></span>
<span class="line"><span style="color:#676E95;"> * certain actions if some rule is satisfied.</span></span>
<span class="line"><span style="color:#676E95;"> *</span></span>
<span class="line"><span style="color:#676E95;"> * </span><span style="color:#C792EA;">\\return</span></span>
<span class="line"><span style="color:#676E95;"> *         True means the next Object is available. Otherwise, return</span></span>
<span class="line"><span style="color:#676E95;"> *         false.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"><span style="color:#C792EA;">bool</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">IndexLookup</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">isReady</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> ... </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>Once again, most of this documentation, such as the reference to DCFT and the entire second paragraph, concerns the implementation, so it doesn\u2019t belong here; this is one of the most common errors in interface comments. Some of the implementation documentation is useful, but it should go inside the method, where it will be clearly separated from interface documentation. In addition, the first sentence of the documentation is cryptic (what does RESULT_READY mean?) and some important information is missing. Finally, it isn\u2019t necessary to describe the implementation of getNext here. Here is a better version of the comment:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/*</span></span>
<span class="line"><span style="color:#676E95;"> * Indicates whether an indexed read has made enough progress for</span></span>
<span class="line"><span style="color:#676E95;"> * getNext to return immediately without blocking. In addition, this</span></span>
<span class="line"><span style="color:#676E95;"> * method does most of the real work for indexed reads, so it must</span></span>
<span class="line"><span style="color:#676E95;"> * be invoked (either directly, or indirectly by calling getNext) in</span></span>
<span class="line"><span style="color:#676E95;"> * order for the indexed read to make progress.</span></span>
<span class="line"><span style="color:#676E95;"> *</span></span>
<span class="line"><span style="color:#676E95;"> * \\return</span></span>
<span class="line"><span style="color:#676E95;"> *         True means that the next invocation of getNext will not block</span></span>
<span class="line"><span style="color:#676E95;"> *         (at least one object is available to return, or the end of the</span></span>
<span class="line"><span style="color:#676E95;"> *         lookup has been reached); false means getNext may block.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"></span></code></pre></div><p>This version of the comment provides more precise information about what \u201Cready\u201D means, and it provides the important information that this method must eventually be invoked if the indexed retrieval is to move forward.</p><h2 id="_13-6-implementation-comments-what-and-why-not-how" tabindex="-1">13.6 Implementation comments: what and why, not how <a class="header-anchor" href="#_13-6-implementation-comments-what-and-why-not-how" aria-hidden="true">#</a></h2><p>Implementation comments are the comments that appear inside methods to help readers understand how they work internally. Most methods are so short and simple that they don\u2019t need any implementation comments: given the code and the interface comments, it\u2019s easy to figure out how a method works.</p><p>The main goal of implementation comments is to help readers understand what the code is doing (not how it does it). Once readers know what the code is trying to do, it\u2019s usually easy to understand how the code works. For short methods, the code only does one thing, which is already described in its interface comment, so no implementation comments are needed. Longer methods have several blocks of code that do different things as part of the method\u2019s overall task. Add a comment before each of the major blocks to provide a high-level (more abstract) description of what that block does. Here is an example:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">// Phase 1: Scan active RPCs to see if any have completed.</span></span>
<span class="line"></span></code></pre></div><p>For loops, it\u2019s helpful to have a comment before the loop that describes what happens in each iteration:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">// Each iteration of the following loop extracts one request from</span></span>
<span class="line"><span style="color:#676E95;">// the request message, increments the corresponding object, and</span></span>
<span class="line"><span style="color:#676E95;">// appends a response to the response message.</span></span>
<span class="line"></span></code></pre></div><p>Notice how this comment describes the loop at a more abstract and intuitive level; it doesn\u2019t go into any details about how a request is extracted from the request message or how the object is incremented. Loop comments are only needed for longer or more complex loops, where it may not be obvious what the loop is doing; many loops are short and simple enough that their behavior is already obvious.</p><p>In addition to describing what the code is doing, implementation comments are also useful to explain why. If there are tricky aspects to the code that won\u2019t be obvious from reading it, you should document them. For example, if a bug fix requires the addition of code whose purpose isn\u2019t totally obvious, add a comment describing why the code is needed. For bug fixes where there is a well-written bug report describing the problem, the comment can refer to the issue in the bug tracking database rather than repeating all its details (\u201CFixes RAM-436, related to device driver crashes in Linux 2.4.x\u201D). Developers can look in the bug database for more details (this is an example of avoiding duplication in comments, which will be discussed in Chapter 16).</p><p>For longer methods, it can be helpful to write comments for a few of the most important local variables. However, most local variables don\u2019t need documentation if they have good names. If all of the uses of a variable are visible within a few lines of each other, it\u2019s usually easy to understand the variable\u2019s purpose without a comment. In this case it\u2019s OK to let readers read the code to figure out the meaning of the variable. However, if the variable is used over a large span of code, then you should consider adding a comment to describe the variable. When documenting variables, focus on what the variable represents, not how it is manipulated in the code.</p><h2 id="_13-7-cross-module-design-decisions" tabindex="-1">13.7 Cross-module design decisions <a class="header-anchor" href="#_13-7-cross-module-design-decisions" aria-hidden="true">#</a></h2><p>In a perfect world, every important design decision would be encapsulated within a single class. Unfortunately, real systems inevitably end up with design decisions that affect multiple classes. For example, the design of a network protocol will affect both the sender and the receiver, and these may be implemented in different places. Cross-module decisions are often complex and subtle, and they account for many bugs, so good documentation for them is crucial.</p><p>The biggest challenge with cross-module documentation is finding a place to put it where it will naturally be discovered by developers. Sometimes there is an obvious central place to put such documentation. For example, the RAMCloud storage system defines a Status value, which is returned by each request to indicate success or failure. Adding a Status for a new error condition requires modifying many different files (one file maps Status values to exceptions, another provides a human-readable message for each Status, and so on). Fortunately, there is one obvious place where developers will have to go when adding a new status value, which is the declaration of the Status enum. We took advantage of this by adding comments in that enum to identify all of the other places that must also be modified:</p><div class="language-cpp"><button class="copy"></button><span class="lang">cpp</span><pre><code><span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">enum</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Status</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">STATUS_OK</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">STATUS_UNKNOWN_TABLET</span><span style="color:#F07178;">                </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">STATUS_WRONG_VERSION</span><span style="color:#F07178;">                 </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    ...</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">STATUS_INDEX_DOESNT_EXIST</span><span style="color:#F07178;">            </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">29</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">STATUS_INVALID_PARAMETER</span><span style="color:#F07178;">             </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">30</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#A6ACCD;">STATUS_MAX_VALUE</span><span style="color:#F07178;">                     </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">30</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#676E95;">    // Note: if you add a new status value you must make the following</span></span>
<span class="line"><span style="color:#676E95;">    // additional updates:</span></span>
<span class="line"><span style="color:#676E95;">    // (1)  Modify STATUS_MAX_VALUE to have a value equal to the</span></span>
<span class="line"><span style="color:#676E95;">    //      largest defined status value, and make sure its definition</span></span>
<span class="line"><span style="color:#676E95;">    //      is the last one in the list. STATUS_MAX_VALUE is used</span></span>
<span class="line"><span style="color:#676E95;">    //      primarily for testing.</span></span>
<span class="line"><span style="color:#676E95;">    // (2)  Add new entries in the tables &quot;messages&quot; and &quot;symbols&quot; in</span></span>
<span class="line"><span style="color:#676E95;">    //      Status.cc.</span></span>
<span class="line"><span style="color:#676E95;">    // (3)  Add a new exception class to ClientException.h</span></span>
<span class="line"><span style="color:#676E95;">    // (4)  Add a new &quot;case&quot; to ClientException::throwException to map</span></span>
<span class="line"><span style="color:#676E95;">    //      from the status value to a status-specific ClientException</span></span>
<span class="line"><span style="color:#676E95;">    //      subclass.</span></span>
<span class="line"><span style="color:#676E95;">    // (5)  In the Java bindings, add a static class for the exception</span></span>
<span class="line"><span style="color:#676E95;">    //      to ClientException.java</span></span>
<span class="line"><span style="color:#676E95;">    // (6)  Add a case for the status of the exception to throw the</span></span>
<span class="line"><span style="color:#676E95;">    //      exception in ClientException.java</span></span>
<span class="line"><span style="color:#676E95;">    // (7)  Add the exception to the Status enum in Status.java, making</span></span>
<span class="line"><span style="color:#676E95;">    //      sure the status is in the correct position corresponding to</span></span>
<span class="line"><span style="color:#676E95;">    //      its status code.</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>New status values will be added at the end of the existing list, so the comments are also placed at the end, where they are most likely to be seen.</p><p>Unfortunately, in many cases there is not an obvious central place to put cross-module documentation. One example from the RAMCloud storage system was the code for dealing with zombie servers, which are servers that the system believes have crashed, but in fact are still running. Neutralizing zombie servers required code in several different modules, and these pieces of code all depend on each other. None of the pieces of code is an obvious central place to put documentation. One possibility is to duplicate parts of the documentation in each location that depends on it. However, this is awkward, and it is difficult to keep such documentation up to date as the system evolves. Alternatively, the documentation can be located in one of the places where it is needed, but in this case it\u2019s unlikely that developers will see the documentation or know where to look for it.</p><p>I have recently been experimenting with an approach where cross-module issues are documented in a central file called designNotes. The file is divided up into clearly labeled sections, one for each major topic. For example, here is an excerpt from the file:</p><div class="language-"><button class="copy"></button><span class="lang"></span><pre><code><span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">Zombies</span></span>
<span class="line"><span style="color:#A6ACCD;">-------</span></span>
<span class="line"><span style="color:#A6ACCD;">A zombie is a server that is considered dead by the rest of the</span></span>
<span class="line"><span style="color:#A6ACCD;">cluster; any data stored on the server has been recovered and will</span></span>
<span class="line"><span style="color:#A6ACCD;">be managed by other servers. However, if a zombie is not actually</span></span>
<span class="line"><span style="color:#A6ACCD;">dead (e.g., it was just disconnected from the other servers for a</span></span>
<span class="line"><span style="color:#A6ACCD;">while) two forms of inconsistency can arise:</span></span>
<span class="line"><span style="color:#A6ACCD;">* A zombie server must not serve read requests once replacement servers have taken over; otherwise it may return stale data that does not reflect writes accepted by the replacement servers.</span></span>
<span class="line"><span style="color:#A6ACCD;">* The zombie server must not accept write requests once replacement servers have begun replaying its log during recovery; if it does, these writes may be lost (the new values may not be stored on the replacement servers and thus will not be returned by reads).</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">RAMCloud uses two techniques to neutralize zombies. First,</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>Then, in any piece of code that relates to one of these issues there is a short comment referring to the designNotes file:</p><div class="language-c"><button class="copy"></button><span class="lang">c</span><pre><code><span class="line"><span style="color:#676E95;">// See &quot;Zombies&quot; in designNotes.</span></span>
<span class="line"></span></code></pre></div><p>With this approach, there is only a single copy of the documentation and it is relatively easy for developers to find it when they need it. However, this has the disadvantage that the documentation is not near any of the pieces of code that depend on it, so it may be difficult to keep up-to-date as the system evolves.</p><h2 id="_13-8-conclusion" tabindex="-1">13.8 Conclusion <a class="header-anchor" href="#_13-8-conclusion" aria-hidden="true">#</a></h2><p>The goal of comments is to ensure that the structure and behavior of the system is obvious to readers, so they can quickly find the information they need and make modifications to the system with confidence that they will work. Some of this information can be represented in the code in a way that will already be obvious to readers, but there is a significant amount of information that can\u2019t easily be deduced from the code. Comments fill in this information.</p><p>When following the rule that comments should describe things that aren\u2019t obvious from the code, \u201Cobvious\u201D is from the perspective of someone reading your code for the first time (not you). When writing comments, try to put yourself in the mindset of the reader and ask yourself what are the key things he or she will need to know. If your code is undergoing review and a reviewer tells you that something is not obvious, don\u2019t argue with them; if a reader thinks it\u2019s not obvious, then it\u2019s not obvious. Instead of arguing, try to understand what they found confusing and see if you can clarify that, either with better comments or better code.</p><h2 id="_13-9-answers-to-questions-from-section-13-5" tabindex="-1">13.9 Answers to questions from Section 13.5 <a class="header-anchor" href="#_13-9-answers-to-questions-from-section-13-5" aria-hidden="true">#</a></h2><p>Does a developer need to know each of the following pieces of information in order to use the IndexLookup class?</p><ol><li>The format of messages that the IndexLookup class sends to the servers holding indexes and objects. No: this is an implementation detail that should be hidden within the class.</li><li>The comparison function used to determine whether a particular object falls in the desired range (is comparison done using integers, floating-point numbers, or strings?). Yes: users of the class need to know this information.</li><li>The data structure used to store indexes on servers. No: this information should be encapsulated on the servers; not even the implementation of IndexLookup should need to know this.</li><li>Whether or not IndexLookup issues multiple requests to different servers concurrently. Possibly: if IndexLookup uses special techniques to improve performance, then the documentation should provide some high-level information about this, since users may care about performance.</li><li>The mechanism for handling server crashes. No: RAMCloud recovers automatically from server crashes, so crashes are not visible to application-level software; thus, there is no need to mention crashes in the interface documentation for IndexLookup. If crashes were reflected up to applications, then the interface documentation would need to describe how they manifest themselves (but not the details of how crash recovery works).</li></ol><hr>`,120),l=[o];function p(r,i,c,h,d,m){return n(),s("div",null,l)}const f=e(t,[["render",p]]);export{u as __pageData,f as default};
