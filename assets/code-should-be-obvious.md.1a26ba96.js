import{_ as s,c as e,o as a,a as n}from"./app.4e4aba59.js";const D=JSON.parse('{"title":"Chapter 18 Code Should be Obvious","description":"","frontmatter":{},"headers":[{"level":2,"title":"18.1 Things that make code more obvious","slug":"_18-1-things-that-make-code-more-obvious"},{"level":2,"title":"18.2 Things that make code less obvious","slug":"_18-2-things-that-make-code-less-obvious"},{"level":2,"title":"18.3 Conclusion","slug":"_18-3-conclusion"}],"relativePath":"code-should-be-obvious.md","lastUpdated":1661091751000}'),o={name:"code-should-be-obvious.md"},t=n(`<h1 id="chapter-18-code-should-be-obvious" tabindex="-1">Chapter 18 Code Should be Obvious <a class="header-anchor" href="#chapter-18-code-should-be-obvious" aria-hidden="true">#</a></h1><p>Obscurity is one of the two main causes of complexity described in Section 2.3. Obscurity occurs when important information about a system is not obvious to new developers. The solution to the obscurity problem is to write code in a way that makes it obvious; this chapter discusses some of the factors that make code more or less obvious.</p><p>If code is obvious, it means that someone can read the code quickly, without much thought, and their first guesses about the behavior or meaning of the code will be correct. If code is obvious, a reader doesn\u2019t need to spend much time or effort to gather all the information they need to work with the code. If code is not obvious, then a reader must expend a lot of time and energy to understand it. Not only does this reduce their efficiency, but it also increases the likelihood of misunderstanding and bugs. Obvious code needs fewer comments than nonobvious code.</p><p>\u201CObvious\u201D is in the mind of the reader: it\u2019s easier to notice that someone else\u2019s code is nonobvious than to see problems with your own code. Thus, the best way to determine the obviousness of code is through code reviews. If someone reading your code says it\u2019s not obvious, then it\u2019s not obvious, no matter how clear it may seem to you. By trying to understand what made the code nonobvious, you will learn how to write better code in the future.</p><h2 id="_18-1-things-that-make-code-more-obvious" tabindex="-1">18.1 Things that make code more obvious <a class="header-anchor" href="#_18-1-things-that-make-code-more-obvious" aria-hidden="true">#</a></h2><p>Two of the most important techniques for making code obvious have already been discussed in previous chapters. The first is choosing good names (Chapter 14). Precise and meaningful names clarify the behavior of the code and reduce the need for documentation. If a name is vague or ambiguous, then readers will have read through the code in order to deduce the meaning of the named entity; this is time-consuming and error-prone. The second technique is consistency (Chapter 17). If similar things are always done in similar ways, then readers can recognize patterns they have seen before and immediately draw (safe) conclusions without analyzing the code in detail.</p><p>Here are a few other general-purpose techniques for making code more obvious:</p><p>Judicious use of white space. The way code is formatted can impact how easy it is to understand. Consider the following parameter documentation, in which whitespace has been squeezed out:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;"> *  ...</span></span>
<span class="line"><span style="color:#676E95;"> *  </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">numThreads</span><span style="color:#676E95;"> The number of threads that this manager should</span></span>
<span class="line"><span style="color:#676E95;"> *  spin up in order to manage ongoing connections. The MessageManager</span></span>
<span class="line"><span style="color:#676E95;"> *  spins up at least one thread for every open connection, so this</span></span>
<span class="line"><span style="color:#676E95;"> *  should be at least equal to the number of connections you expect</span></span>
<span class="line"><span style="color:#676E95;"> *  to be open at once. This should be a multiple of that number if</span></span>
<span class="line"><span style="color:#676E95;"> *  you expect to send a lot of messages in a short amount of time.</span></span>
<span class="line"><span style="color:#676E95;"> *  </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">handler</span><span style="color:#676E95;"> Used as a callback in order to handle incoming</span></span>
<span class="line"><span style="color:#676E95;"> *  messages on this MessageManager&#39;s open connections. See</span></span>
<span class="line"><span style="color:#676E95;"> *  {@code MessageHandler} and {@code handleMessage} for details.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"></span></code></pre></div><p>It\u2019s hard to see where the documentation for one parameter ends and the next begins. It\u2019s not even obvious how many parameters there are, or what their names are. If a little whitespace is added, the structure suddenly becomes clear and the documentation is easier to scan:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;"> *  </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">numThreads</span></span>
<span class="line"><span style="color:#676E95;"> *           The number of threads that this manager should spin up in</span></span>
<span class="line"><span style="color:#676E95;"> *           order to manage ongoing connections. The MessageManager spins</span></span>
<span class="line"><span style="color:#676E95;"> *           up at least one thread for every open connection, so this</span></span>
<span class="line"><span style="color:#676E95;"> *           should be at least equal to the number of connections you</span></span>
<span class="line"><span style="color:#676E95;"> *           expect to be open at once. This should be a multiple of that</span></span>
<span class="line"><span style="color:#676E95;"> *           number if you expect to send a lot of messages in a short</span></span>
<span class="line"><span style="color:#676E95;"> *           amount of time.</span></span>
<span class="line"><span style="color:#676E95;"> *  </span><span style="color:#F78C6C;">@param</span><span style="color:#676E95;"> </span><span style="color:#A6ACCD;">handler</span></span>
<span class="line"><span style="color:#676E95;"> *           Used as a callback in order to handle incoming messages on</span></span>
<span class="line"><span style="color:#676E95;"> *           this MessageManager&#39;s open connections. See</span></span>
<span class="line"><span style="color:#676E95;"> *           {@code MessageHandler} and {@code handleMessage} for details.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"></span></code></pre></div><p>Blank lines are also useful to separate major blocks of code within a method, such as in the following example:</p><div class="language-cpp"><button class="copy"></button><span class="lang">cpp</span><pre><code><span class="line"><span style="color:#C792EA;">void*</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Buffer</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">allocAux</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">size_t</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">numBytes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#676E95;">    //  Round up the length to a multiple of 8 bytes, to ensure alignment.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> numBytes32 </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">downCast</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">uint32_t</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">numBytes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">~</span><span style="color:#F78C6C;">0x7</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">assert</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">numBytes32 </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    //  If there is enough memory at firstAvailable, use that. Work down</span></span>
<span class="line"><span style="color:#676E95;">    //  from the top, because this memory is guaranteed to be aligned</span></span>
<span class="line"><span style="color:#676E95;">    //  (memory at the bottom may have been used for variable-size chunks).</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">availableLength </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> numBytes32</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        availableLength </span><span style="color:#89DDFF;">-=</span><span style="color:#F07178;"> numBytes32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> firstAvailable </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> availableLength</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    //  Next, see if there is extra space at the end of the last chunk.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">if</span><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">extraAppendBytes </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> numBytes32</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        extraAppendBytes </span><span style="color:#89DDFF;">-=</span><span style="color:#F07178;"> numBytes32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lastChunk</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">data</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">lastChunk</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">length</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">+</span><span style="color:#F07178;"> extraAppendBytes</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;">    //  Must create a new space allocation; allocate space within it.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">uint32_t</span><span style="color:#A6ACCD;"> allocatedLength</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    firstAvailable </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getNewAllocation</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">numBytes32</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#A6ACCD;">allocatedLength</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    availableLength </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> allocatedLength numBytes32</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> firstAvailable </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> availableLength</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>This approach works particularly well if the first line after each blank line is a comment describing the next block of code: the blank lines make the comments more visible.</p><p>White space within a statement helps to clarify the structure of the statement. Compare the following two statements, one of which has whitespace and one of which doesn\u2019t:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">for</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> pass</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">pass</span><span style="color:#89DDFF;">&gt;=</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">&amp;&amp;!</span><span style="color:#A6ACCD;">empty</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">pass</span><span style="color:#89DDFF;">--)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> pass </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> pass </span><span style="color:#89DDFF;">&gt;=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">empty</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> pass</span><span style="color:#89DDFF;">--)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span></code></pre></div><p>Comments. Sometimes it isn\u2019t possible to avoid code that is nonobvious. When this happens, it\u2019s important to use comments to compensate by providing the missing information. To do this well, you must put yourself in the position of the reader and figure out what is likely to confuse them, and what information will clear up that confusion. The next section shows a few examples.</p><h2 id="_18-2-things-that-make-code-less-obvious" tabindex="-1">18.2 Things that make code less obvious <a class="header-anchor" href="#_18-2-things-that-make-code-less-obvious" aria-hidden="true">#</a></h2><p>There are many things that can make code nonobvious; this section provides a few examples. Some of these, such as event-driven programming, are useful in some situations, so you may end up using them anyway. When this happens, extra documentation can help to minimize reader confusion.</p><p>Event-driven programming. In event-driven programming, an application responds to external occurrences, such as the arrival of a network packet or the press of a mouse button. One module is responsible for reporting incoming events. Other parts of the application register interest in certain events by asking the event module to invoke a given function or method when those events occur.</p><p>Event-driven programming makes it hard to follow the flow of control. The event handler functions are never invoked directly; they are invoked indirectly by the event module, typically using a function pointer or interface. Even if you find the point of invocation in the event module, it still isn\u2019t possible to tell which specific function will be invoked: this will depend on which handlers were registered at runtime. Because of this, it\u2019s hard to reason about event-driven code or convince yourself that it works.</p><p>To compensate for this obscurity, use the interface comment for each handler function to indicate when it is invoked, as in this example:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#676E95;">/**</span></span>
<span class="line"><span style="color:#676E95;"> * This method is invoked in the dispatch thread by a transport if a</span></span>
<span class="line"><span style="color:#676E95;"> * transport-level error prevents an RPC from completing.</span></span>
<span class="line"><span style="color:#676E95;"> */</span></span>
<span class="line"><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> Transport</span><span style="color:#89DDFF;">::</span><span style="color:#A6ACCD;">RpcNotifier</span><span style="color:#89DDFF;">::</span><span style="color:#82AAFF;">failed</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>img Red Flag: Nonobvious Code img</p><p>If the meaning and behavior of code cannot be understood with a quick reading, it is a red flag. Often this means that there is important information that is not immediately clear to someone reading the code.</p><p>Generic containers. Many languages provide generic classes for grouping two or more items into a single object, such as Pair in Java or std::pair in C++. These classes are tempting because they make it easy to pass around several objects with a single variable. One of the most common uses is to return multiple values from a method, as in this Java example:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#89DDFF;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Pair</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Integer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Boolean</span><span style="color:#89DDFF;">&gt;(</span><span style="color:#A6ACCD;">currentTerm</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false);</span></span>
<span class="line"></span></code></pre></div><p>Unfortunately, generic containers result in nonobvious code because the grouped elements have generic names that obscure their meaning. In the example above, the caller must reference the two returned values with result.getKey() and result.getValue(), which give no clue about the actual meaning of the values.</p><p>Thus, it\u2019s better not to use generic containers. If you need a container, define a new class or structure that is specialized for the particular use. You can then use meaningful names for the elements, and you can provide additional documentation in the declaration, which is not possible with the generic container.</p><p>This example illustrates a general rule: software should be designed for ease of reading, not ease of writing. Generic containers are expedient for the person writing the code, but they create confusion for all the readers that follow. It\u2019s better for the person writing the code to spend a few extra minutes to define a specific container structure, so that the resulting code is more obvious.</p><p>Different types for declaration and allocation. Consider the following Java example:</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">List</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Message</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> incomingMessageList</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">incomingMessageList </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">ArrayList</span><span style="color:#89DDFF;">&lt;</span><span style="color:#C792EA;">Message</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"></span></code></pre></div><p>The variable is declared as a List, but the actual value is an ArrayList. This code is legal, since List is a superclass of ArrayList, but it can mislead a reader who sees the declaration but not the actual allocation. The actual type may impact how the variable is used (ArrayLists have different performance and thread-safety properties than other subclasses of List), so it is better to match the declaration with the allocation.</p><p>Code that violates reader expectations. Consider the following code, which is the main program for a Java application</p><div class="language-java"><button class="copy"></button><span class="lang">java</span><pre><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">main</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">String</span><span style="color:#89DDFF;">[]</span><span style="color:#A6ACCD;"> args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">...</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">RaftClient</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">myAddress</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> serverAddresses</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><p>Most applications exit when their main programs return, so readers are likely to assume that will happen here. However, that is not the case. The constructor for RaftClient creates additional threads, which continue to operate even though the application\u2019s main thread finishes. This behavior should be documented in the interface comment for the RaftClient constructor, but the behavior is nonobvious enough that it\u2019s worth putting a short comment at the end of main as well. The comment should indicate that the application will continue executing in other threads. Code is most obvious if it conforms to the conventions that readers will be expecting; if it doesn\u2019t, then it\u2019s important to document the behavior so readers aren\u2019t confused.</p><h2 id="_18-3-conclusion" tabindex="-1">18.3 Conclusion <a class="header-anchor" href="#_18-3-conclusion" aria-hidden="true">#</a></h2><p>Another way of thinking about obviousness is in terms of information. If code is nonobvious, that usually means there is important information about the code that the reader does not have: in the RaftClient example, the reader might not know that the RaftClient constructor created new threads; in the Pair example, the reader might not know that result.getKey() returns the number of the current term.</p><p>To make code obvious, you must ensure that readers always have the information they need to understand it. You can do this in three ways. The best way is to reduce the amount of information that is needed, using design techniques such as abstraction and eliminating special cases. Second, you can take advantage of information that readers have already acquired in other contexts (for example, by following conventions and conforming to expectations) so readers don\u2019t have to learn new information for your code. Third, you can present the important information to them in the code, using techniques such as good names and strategic comments.</p>`,39),l=[t];function p(r,i,c,h,y,d){return a(),e("div",null,l)}const m=s(o,[["render",p]]);export{D as __pageData,m as default};
